<header class="header">
    <div class="container">
        <div class="nav-container">
            <div class="logo">
                <a href="{{ '/' | relative_url }}">
                    {% if site.logo %}
                        <img src="{{ site.logo | relative_url }}" alt="{{ site.title }} Logo">
                    {% endif %}
                    <span>{{ site.title_short | default: site.title }}</span>
                </a>
            </div>
            
            <nav class="nav">
                <!-- Search Icon -->
                <button class="search-toggle" id="searchToggle" aria-label="Search">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
                    </svg>
                </button>

                <!-- Theme Toggle -->
                <button class="theme-toggle" id="themeToggle" aria-label="Toggle dark mode">
                    <svg class="sun-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"></path>
                    </svg>
                    <svg class="moon-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                    </svg>
                </button>

                <!-- Mobile Navigation Toggle -->
                <div class="hamburger">
                    <span class="bar"></span>
                    <span class="bar"></span>
                    <span class="bar"></span>
                </div>
            </nav>
        </div>
    </div>

    <!-- Desktop Sidebar Navigation -->
    <aside class="desktop-sidebar" id="desktopSidebar">
        <div class="sidebar-content">
            <nav class="sidebar-nav">
                <ul class="nav-menu" id="navMenu">
                    <!-- Navigation items will be populated here -->
                </ul>
            </nav>
        </div>
    </aside>

    <!-- Mobile Navigation Sidebar -->
    <aside class="mobile-nav" id="mobileNav">
        <div class="mobile-nav-content">
            <div class="mobile-nav-header">
                <div class="logo">
                    <a href="{{ '/' | relative_url }}">
                        {% if site.logo %}
                            <img src="{{ site.logo | relative_url }}" alt="{{ site.title }} Logo">
                        {% endif %}
                        <span>{{ site.title_short | default: site.title }}</span>
                    </a>
                </div>
                <button class="mobile-nav-close" id="mobileNavClose" aria-label="Close menu">
                    <svg width="24" height="24" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <div class="mobile-nav-menu" id="mobileNavMenu">
                <!-- Mobile navigation items will be populated here -->
            </div>
            
            <div class="mobile-nav-footer">
                <div class="theme-switch-mobile">
                    <button class="theme-toggle-mobile" id="themeToggleMobile" aria-label="Toggle dark mode">
                        <svg class="sun-icon" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"></path>
                        </svg>
                        <svg class="moon-icon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </aside>

    <!-- Search Overlay -->
    <div class="search-overlay" id="searchOverlay">
        <div class="search-modal">
            <div class="search-header">
                <div class="search-input-container">
                    <svg class="search-icon" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
                    </svg>
                    <input type="text" id="searchInput" placeholder="Search documentation..." autocomplete="off">
                    <button class="search-close" id="searchClose" aria-label="Close search">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="search-results" id="searchResults">
                <div class="search-placeholder">
                    <p>Type here to search</p>
                </div>
            </div>
        </div>
    </div>
</header>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Navigation data structure
    const navigationData = {
        items: [
            {% for item in site.navigation %}
            {
                title: "{{ item.title }}",
                url: "{{ item.url | relative_url }}",
                type: "{{ item.type | default: 'page' }}",
                {% if item.children %}
                children: [
                    {% for child in item.children %}
                    {
                        title: "{{ child.title }}",
                        url: "{{ child.url | relative_url }}"
                    }{% unless forloop.last %},{% endunless %}
                    {% endfor %}
                ]
                {% endif %}
            }{% unless forloop.last %},{% endunless %}
            {% endfor %}
        ]
    };

    // Tree state for collapsed/expanded folders
    const treeState = {};

    // Initialize navigation
    function initNavigation() {
        renderDesktopNavigation();
        renderMobileNavigation();
        setupNavigationEvents();
        markCurrentPage();
    }

    // Render desktop navigation
    function renderDesktopNavigation() {
        const navMenu = document.getElementById('navMenu');
        if (!navMenu) return;

        navMenu.innerHTML = generateNavigationHTML(navigationData.items, false);
    }

    // Render mobile navigation
    function renderMobileNavigation() {
        const mobileNavMenu = document.getElementById('mobileNavMenu');
        if (!mobileNavMenu) return;

        mobileNavMenu.innerHTML = generateNavigationHTML(navigationData.items, true);
    }

    // Generate navigation HTML
    function generateNavigationHTML(items, isMobile = false) {
        let html = '';
        
        items.forEach(item => {
            if (item.type === 'separator') {
                html += `<li class="nav-separator">${item.title || '<hr>'}</li>`;
                return;
            }

            const hasChildren = item.children && item.children.length > 0;
            const isActive = isItemActive(item);
            const isCurrent = isCurrentPage(item);
            const isOpen = treeState[item.url] !== undefined ? treeState[item.url] : isActive;

            if (hasChildren) {
                html += `
                    <li class="nav-item nav-folder ${isOpen ? 'open' : ''} ${isActive ? 'active' : ''}">
                        <button class="nav-link folder-toggle" data-url="${item.url}">
                            <span>${item.title}</span>
                            <svg class="folder-arrow" width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                        <div class="nav-collapse ${isOpen ? 'open' : ''}">
                            <ul class="nav-submenu">
                                ${generateNavigationHTML(item.children, isMobile)}
                            </ul>
                        </div>
                    </li>
                `;
            } else {
                html += `
                    <li class="nav-item ${isCurrent ? 'current-page' : ''}">
                        <a href="${item.url}" class="nav-link ${isCurrent ? 'exact-active' : ''}">
                            ${item.title}
                        </a>
                    </li>
                `;
            }
        });

        return html;
    }

    // Check if item is active (for folder highlighting)
    function isItemActive(item) {
        const currentPath = normalizePath(window.location.pathname);
        
        if (item.children) {
            return item.children.some(child => {
                const childPath = normalizePath(child.url);
                return currentPath === childPath || currentPath.startsWith(childPath + '/');
            });
        }
        
        const itemPath = normalizePath(item.url);
        return currentPath.startsWith(itemPath);
    }

    // Check if item is the exact current page
    function isCurrentPage(item) {
        const currentPath = normalizePath(window.location.pathname);
        const itemPath = normalizePath(item.url);
        return currentPath === itemPath;
    }

    // Normalize paths for comparison
    function normalizePath(path) {
        return path.replace(/\/$/, '') || '/';
    }

    // Mark current page after DOM is rendered
    function markCurrentPage() {
        const currentPath = normalizePath(window.location.pathname);
        
        document.querySelectorAll('.nav-link').forEach(link => {
            const linkPath = normalizePath(link.getAttribute('href'));
            if (linkPath === currentPath) {
                link.classList.add('exact-active');
                link.closest('.nav-item').classList.add('current-page');
                
                // Auto-expand parent folders
                let parentFolder = link.closest('.nav-collapse');
                while (parentFolder) {
                    const folder = parentFolder.previousElementSibling;
                    if (folder && folder.classList.contains('folder-toggle')) {
                        const folderItem = folder.closest('.nav-folder');
                        folderItem.classList.add('open', 'active');
                        parentFolder.classList.add('open');
                        
                        const folderUrl = folder.dataset.url;
                        if (folderUrl) {
                            treeState[folderUrl] = true;
                        }
                    }
                    parentFolder = parentFolder.parentElement.closest('.nav-collapse');
                }
            }
        });
    }

    // Setup navigation event listeners
    function setupNavigationEvents() {
        // Folder toggle
        document.querySelectorAll('.folder-toggle').forEach(button => {
            button.addEventListener('click', function() {
                const url = this.dataset.url;
                const folder = this.closest('.nav-folder');
                const collapse = this.nextElementSibling;
                
                treeState[url] = !folder.classList.contains('open');
                
                folder.classList.toggle('open');
                collapse.classList.toggle('open');
            });
        });

        // Mobile nav toggle
        const hamburger = document.querySelector('.hamburger');
        const mobileNav = document.getElementById('mobileNav');
        const mobileNavClose = document.getElementById('mobileNavClose');

        if (hamburger && mobileNav) {
            hamburger.addEventListener('click', function() {
                mobileNav.classList.add('active');
                document.body.style.overflow = 'hidden';
            });
        }

        if (mobileNavClose) {
            mobileNavClose.addEventListener('click', function() {
                mobileNav.classList.remove('active');
                document.body.style.overflow = '';
            });
        }

        // Close mobile nav when clicking on links
        document.querySelectorAll('.mobile-nav .nav-link').forEach(link => {
            link.addEventListener('click', function() {
                mobileNav.classList.remove('active');
                document.body.style.overflow = '';
            });
        });

        // Close mobile nav when clicking outside
        if (mobileNav) {
            mobileNav.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('active');
                    document.body.style.overflow = '';
                }
            });
        }
    }

    // Theme functionality
    const themeToggle = document.getElementById('themeToggle');
    const themeToggleMobile = document.getElementById('themeToggleMobile');
    
    function initTheme() {
        const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
        const currentTheme = localStorage.getItem('theme') || 
                            (prefersDarkScheme.matches ? 'dark' : 'light');
        
        document.documentElement.setAttribute('data-theme', currentTheme);
        
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }
        
        if (themeToggle) themeToggle.addEventListener('click', toggleTheme);
        if (themeToggleMobile) themeToggleMobile.addEventListener('click', toggleTheme);
    }

    // Search functionality
    const searchToggle = document.getElementById('searchToggle');
    const searchOverlay = document.getElementById('searchOverlay');
    const searchClose = document.getElementById('searchClose');
    const searchInput = document.getElementById('searchInput');
    const searchResults = document.getElementById('searchResults');
    
    let lunrIndex = null;
    let searchData = {};

    function initSearch() {
        fetch('{{ "/assets/js/search-data.json" | relative_url }}')
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => {
                searchData = data;
                
                lunrIndex = lunr(function() {
                    this.ref('id');
                    this.field('title', { boost: 15 });
                    this.field('content', { boost: 1 });
                    this.field('doc', { boost: 10 });
                    
                    this.pipeline.remove(lunr.stemmer);
                    this.searchPipeline.remove(lunr.stemmer);
                    
                    for (const id in searchData) {
                        this.add({
                            id: id,
                            title: searchData[id].title || '',
                            content: searchData[id].content || '',
                            doc: searchData[id].doc || ''
                        });
                    }
                });
            })
            .catch(error => {
                console.error('Search init failed:', error);
                searchResults.innerHTML = '<div class="search-error"><p>Search temporarily unavailable</p></div>';
            });
    }

    function openSearch() {
        searchOverlay.classList.add('active');
        document.body.style.overflow = 'hidden';
        searchInput.focus();
        if (!lunrIndex) initSearch();
    }

    function closeSearch() {
        searchOverlay.classList.remove('active');
        document.body.style.overflow = '';
        searchInput.value = '';
        searchResults.innerHTML = '<div class="search-placeholder"><p>Type here to search</p></div>';
    }

    function performSearch(query) {
        if (!query.trim()) {
            searchResults.innerHTML = '<div class="search-placeholder"><p>Type here to search</p></div>';
            return;
        }
        
        if (!lunrIndex) {
            searchResults.innerHTML = '<div class="search-error"><p>Search index loading...</p></div>';
            return;
        }

        try {
            const searchQuery = query.length < 3 ? `*${query}*` : query;
            const results = lunrIndex.search(searchQuery);
            displayResults(results, query);
        } catch (error) {
            console.error('Search error:', error);
            fallbackSearch(query);
        }
    }

    function fallbackSearch(query) {
        const results = [];
        const queryLower = query.toLowerCase();
        
        for (const id in searchData) {
            const item = searchData[id];
            const title = item.title ? item.title.toLowerCase() : '';
            const content = item.content ? item.content.toLowerCase() : '';
            const doc = item.doc ? item.doc.toLowerCase() : '';
            
            if (title.includes(queryLower) || content.includes(queryLower) || doc.includes(queryLower)) {
                results.push({ ref: id, score: 1 });
            }
        }
        
        results.sort((a, b) => {
            const itemA = searchData[a.ref];
            const itemB = searchData[b.ref];
            const titleMatchA = itemA.title.toLowerCase().includes(queryLower);
            const titleMatchB = itemB.title.toLowerCase().includes(queryLower);
            
            if (titleMatchA && !titleMatchB) return -1;
            if (!titleMatchA && titleMatchB) return 1;
            return 0;
        });
        
        displayResults(results, query);
    }

    function displayResults(results, query) {
        if (results.length === 0) {
            searchResults.innerHTML = `<div class="search-no-results"><p>No results found for "${query}"</p></div>`;
            return;
        }

        let html = '<div class="search-results-list">';
        results.slice(0, 10).forEach(result => {
            const item = searchData[result.ref];
            if (!item) return;
            
            const excerpt = createExcerpt(item.content, query);
            
            html += `
                <a href="${item.url}" class="search-result-item">
                    <div class="search-result-content">
                        <div class="search-result-title">${highlightText(item.title, query)}</div>
                        <div class="search-result-excerpt">${excerpt}</div>
                        <div class="search-result-url">${item.relUrl}</div>
                    </div>
                    <svg class="search-result-arrow" width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </a>
            `;
        });
        html += '</div>';
        searchResults.innerHTML = html;
    }

    function createExcerpt(content, query) {
        if (!content) return 'No content available';
        
        const queryLower = query.toLowerCase();
        const contentLower = content.toLowerCase();
        const index = contentLower.indexOf(queryLower);
        
        if (index === -1) {
            return content.substring(0, 150) + '...';
        }
        
        const start = Math.max(0, index - 50);
        const end = Math.min(content.length, index + query.length + 100);
        let excerpt = content.substring(start, end);
        
        if (start > 0) excerpt = '...' + excerpt;
        if (end < content.length) excerpt = excerpt + '...';
        
        return highlightText(excerpt, query);
    }

    function highlightText(text, query) {
        if (!query) return text;
        
        const regex = new RegExp(`(${escapeRegex(query)})`, 'gi');
        return text.replace(regex, '<mark>$1</mark>');
    }

    function escapeRegex(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    // Event listeners for search
    let searchTimeout;
    if (searchToggle) searchToggle.addEventListener('click', openSearch);
    if (searchClose) searchClose.addEventListener('click', closeSearch);
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => performSearch(e.target.value), 150);
        });
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeSearch();
        });
    }
    if (searchOverlay) {
        searchOverlay.addEventListener('click', (e) => {
            if (e.target === searchOverlay) closeSearch();
        });
    }

    // Header scroll effect
    const header = document.querySelector('.header');
    if (header) {
        window.addEventListener('scroll', () => {
            if (window.scrollY > 100) {
                header.classList.add('scrolled');
            } else {
                header.classList.remove('scrolled');
            }
        });
    }

    // Initialize everything
    initNavigation();
    initSearch();
    initTheme();
});
</script>
